name: Sync whitelist.pac

on:
  schedule:
    - cron: '0 */6 * * *' # 每 6 小时同步一次
  workflow_dispatch: {}  # 可手动触发以便测试

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch and convert whitelist.pac
        env:
          URL: https://raw.githubusercontent.com/pexcn/daily/gh-pages/pac/whitelist.pac
          DEST: pac/whitelist.pac
        run: |
          set -euo pipefail
          mkdir -p "$(dirname "$DEST")"
          tmpfile=$(mktemp)
          curl -fsSL "$URL" -o "$tmpfile"
          sed -e 's/SOCKS5 127\.0\.0\.1:1080/SOCKS5 192.168.1.200:7890/g' "$tmpfile" > "$tmpfile.converted"

          if [ -f "$DEST" ]; then
            if cmp -s "$DEST" "$tmpfile.converted"; then
              echo "No changes to $DEST"
              rm -f "$tmpfile" "$tmpfile.converted"
              exit 0
            fi
          fi

          mv "$tmpfile.converted" "$DEST"
          rm -f "$tmpfile"

      - name: Commit and push if changed
        run: |
          if git status --porcelain | grep -q pac/whitelist.pac; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add pac/whitelist.pac
            git commit -m "chore: sync whitelist.pac (update SOCKS5 proxy address)"
            git push
          else
            echo "No changes to commit"
          fi
