name: Sync whitelist.pac

on:
  # 每 3 天同步一次（UTC 时间 00:00，cron 表达式每隔 3 天运行一次）
  schedule:
    - cron: '0 0 */3 * *'
  workflow_dispatch: {}  # 可手动触发以便测试

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      URL: https://raw.githubusercontent.com/pexcn/daily/gh-pages/pac/whitelist.pac
      DEST: pac/whitelist.pac
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main                     # 如果你的默认分支不是 main，请改成对应分支名
          fetch-depth: 0
          persist-credentials: true

      - name: Fetch and convert whitelist.pac
        run: |
          set -euo pipefail
          mkdir -p "$(dirname "$DEST")"
          tmpfile=$(mktemp)
          curl -fsSL "$URL" -o "$tmpfile"
          # 如果需要替换代理地址，保持这一行；否则移除或修改替换规则
          sed -e 's/SOCKS5 127.0.0.1:1080/SOCKS5 192.168.1.200:7890/g' "$tmpfile" > "$tmpfile.converted"
          # 如果目标已存在且内容相同则退出，不做提交
          if [ -f "$DEST" ]; then
            if cmp -s "$DEST" "$tmpfile.converted"; then
              echo "No changes to $DEST"
              rm -f "$tmpfile" "$tmpfile.converted"
              exit 0
            fi
          fi
          mv "$tmpfile.converted" "$DEST"
          rm -f "$tmpfile"

      - name: Debug workspace & git state
        run: |
          echo "GITHUB_REF=$GITHUB_REF"
          echo "Current branch:"
          git rev-parse --abbrev-ref HEAD || true
          echo "Remote:"
          git remote -v || true
          echo "pac dir listing:"
          ls -la pac || true
          echo "pac/whitelist.pac preview:"
          sed -n '1,200p' pac/whitelist.pac || true
          echo "git status (porcelain):"
          git status --porcelain --untracked-files=all || true
          echo "git check-ignore:"
          git check-ignore -v pac/whitelist.pac || true

      - name: Commit and push if changed
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # 尝试添加文件（如果被 .gitignore 忽略，需要调整 .gitignore 或使用 -f 强制）
          git add -v pac/whitelist.pac || true
          echo "Staged status:"
          git status --porcelain --untracked-files=all || true
          # 使用 staged diff 判断是否需要提交
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "chore: sync whitelist.pac (automated)"
          # 将提交推回触发工作流的分支（默认我们在 checkout 时指定了 main）
          branch=${GITHUB_REF#refs/heads/}
          if [ -z "$branch" ] || [ "$branch" = "HEAD" ]; then
            branch=main
          fi
          echo "Pushing to $branch"
          git push origin "HEAD:refs/heads/$branch"

      - name: Done
        run: echo "Sync job finished."
